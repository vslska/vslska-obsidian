 Для запуска контейнеров и изоляции в Docker используются два основных механизма ядра Linux: **cgroups** и **namespaces**. Первый изолирует системные ресурсы, такие как процессорное время и память, а второй изолирует процессы на уровне ОС: идентификаторы процессов, идентификаторы пользователей, им

### Cgroup - *технология управление ресурсами системы*
## Из чего состоят cgroups
Контрольные группы состоят из двух частей:
- **core,** или **основа** — реализует иерархическую организацию процессов;
- **controllers,** или **контроллеры** — отвечают за распространение ресурсов системы CPU, memory и др.

Контрольные группы — это древовидная структура. Треды процесса принадлежат той же группе, что и процесс, а новым процессам назначается та же группа, что и у родительского. Процесс может мигрировать в другую контрольную группу, при этом у дочерних процессов контрольная группа не меняется.
![[Pasted image 20251123043119.png]]

Контроллеры могут быть включены или выключены выборочно для контрольных групп. Поведение всех контроллеров иерархичное. Если контроллер включен для контрольной группы, он автоматически влияет на все процессы, которым назначена данная или дочерние контрольные группы. Также он автоматически ограничивает ресурсы для всех дочерних контрольных групп. Ограничения родительских контрольных групп не могут быть переопределены дочерними контрольными группами.

Какие контроллеры существуют:

- **CPU** Контроллер регулирует распределение циклов процессора. Этот контроллер позволяет задать вес и лимит абсолютной пропускной способности при нормальной политике планировщика, а также лимит абсолютной пропускной способности при планировщике реального времени. В случае достижения лимита по CPU процесс подвергается тротлингу.
- **Memory** Контроллер регулирует распределение памяти. В случае превышения лимита потребления памяти процесс может быть остановлен ядром операционной системы — подсистемой Out of memory killer
-  **IO** Контроллер регулирует распределение ресурсов ввода/вывода. Этот контроллер регулирует пропускную способность или распределяет ресурсы операций ввода-вывода в зависимости от заданного веса или абсолютного значения. Однако распределение в зависимости от заданного веса возможно только при использовании планировщика ввода-вывода CFQ и невозможно для устройств blk-mq.
- **PID** Контроллер идентификаторов процессов позволяет контрольной группе останавливать новые задачи, которые были запущены с использованием системных вызовов `fork()` или `clone()` после того как соответствующий лимит выделенных ресурсов был достигнут.
- **сpuset** Контроллер позволяет привязать процессы в контрольной группе к определенному ядру процессора. Это имеет смысл на больших [NUMA](https://ru.wikipedia.org/wiki/Non-Uniform_Memory_Access)-системах, где правильное распределение процессов по NUMA-нодам позволяет снизить издержки при межнодовом обращении к памяти, что позволяет увеличить общую производительность системы.
- **Device controller** Управляет как созданием новых устройств (с использованием `mknod`), так и доступом к существующим устройствам.
- **RDMA** Контроллер регулирует распределение и учёт [RDMA](https://ru.wikipedia.org/wiki/Удалённый_прямой_доступ_к_памяти)-ресурсов.
- **HugeTLB** Контроллер позволяет ограничить использование [HugeTLB](https://docs.kernel.org/admin-guide/mm/hugetlbpage.html) на контрольную группу и обеспечивает соблюдение ограничения во время [page fault](https://ru.wikipedia.org/wiki/Отказ_страницы).
- **Misc** Обеспечивает механизм ограничения и отслеживания тех ресурсов, которые нельзя абстрагировать как другие ресурсы контрольной группы. Данный контроллер включается отдельным конфигурационным флагом ядра Linux `CONFIG_CGROUP_MISC`.
## Namespaces
Namespaces, или пространства имён — механизм ядра Linux для разделения ресурсов. Он отвечает за то, чтобы каждый набор процессов видел только отведённый ему набор ресурсов ядра. Такие наборы процессов располагаются в разных пространствах имён.

### Какие пространства имён поддерживаются ядром Linux
**Пространство имён пользователей** *user namespace*
Подразумевает независимые наборы идентификаторов пользователей uid, или групп gid, которые могут быть назначены процессу для каждого пространства имен.

> [!NOTE] Важно
> Процесс, запущенный пользователем root (uid = 0) в своем пространстве имён, может не иметь таких привилегий в других пространствах имён.

**Пространство имён идентификаторов процессов** *PID namespace*
Связывает с процессом набор идентификаторов процессов, независимый от наборов идентификаторов процессов в другом пространстве имён. Первый процесс, созданный в новом пространстве, получает идентификатор **1.** Все его дочерние процессы получают последующие идентификаторы. При этом процесс с идентификатором **1** будет иметь отличный идентификатор в пространстве родительского процесса. Пример на схеме:
![[Pasted image 20251123044950.png]]
**Сетевое пространство имён** *network namespace*
Независимый сетевой стек: собственная приватная таблица маршрутизации, наборы IP-адресов, слушающие сокеты — порты, таблица соединений conntrack-table, фаервол и прочие связанные с сетью ресурсы.

**Пространство имён точек монтирования** *mount namespace*
Независимый набор точек монтирования, который видят процессы в этом пространстве имён. Это означает, что вы можете монтировать и размонтировать файловые системы без влияния на хостовую операционную систему.

**Пространство имён межпроцессного взаимодействия** *interprocess communication, или IPC namespace*
Имеет собственный набор IPC-ресурсов. Например, вы не сможете послать сигнал завершения (SIGTERM/SIGKILL) процессу в хостовой операционной системе изнутри IPC namespace.

**Пространство имён** *UNIX Time-Sharing (UTS)*
Позволяет на одной системе иметь независимые имена хоста и домена для различных процессов.

В основном namespaces применяются в контейнеризации, но вы можете использовать эту технологию самостоятельно с помощью, например, утилиты [unshare](https://man7.org/linux/man-pages/man1/unshare.1.html).

> [!NOTE] Важно
> Чтобы запустить один процесс в неймспейсе или неймспейсах другого процесса, можно воспользоваться утилитой [nsenter](https://man7.org/linux/man-pages/man1/nsenter.1.html). Это пригодится для запуска утилиты curl с хостовой системы в сетевом неймспейсе контейнера, если в контейнере этой утилиты нет и добавить её туда нет возможности.

#### Пример на практике: различия между namespaces и cgroups

Представьте, что вы запускаете в Docker контейнере веб-сервер.
- **cgroups:** Ограничивают использование ресурсов. Другими словами, cgroups следят за тем, сколько ресурсов (CPU, памяти, ввода/вывода и т.д.) потребляют группы процессов, и могут регулировать или ограничивать их использование, чтобы один набор процессов не повлиял на работу остальных.
- **namespaces:** Обеспечивают изоляцию. Контейнер имеет собственный сетевой стек, файловую систему и набор процессов, что гарантирует, что его настройки и процессы не будут пересекаться с хостовой системой или другими контейнерами.

Таким образом, cgroups контролируют, сколько ресурсов может использовать веб-сервер, а namespaces изолируют его окружение от остальных процессов системы.

### Что важно запомнить..

- Механизм контрольных групп cgroups состоит из двух частей: основы (ядра) и контроллеров.
- Основа организует иерархию процессов, контроллеры управляют ресурсами системы.
- Главные контроллеры — CPU и memory.
- Механизм namespaces отвечает за то, чтобы выделяемые контроллерами ресурсы не пересекались между наборами процессов.
- В Linux шесть типов пространств имён (namespaces): USER для пользователей, PID для процессов, NETWORK для сетевых ресурсов, MOUNT для точек монтирования, IPC для коммуникации между процессами, UTS для имён хоста и доменов разных процессов.

Материалы:

Про каждый тип контроллера — [в документации ядра Linux](https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v2.html#controllers).

Про устройстве пространств имён — в книге The Linux Programming Interface программиста Michael Kerrisk, сопровождающего проект Linux man-pages:
- [пространство имён пользователей](https://man7.org/linux/man-pages/man7/user_namespaces.7.html);
- [пространство имён идентификаторов процессов](https://man7.org/linux/man-pages/man7/pid_namespaces.7.html);
- [сетевое пространство имён](https://man7.org/linux/man-pages/man7/network_namespaces.7.html);
- [пространство имён точек монтирования](https://man7.org/linux/man-pages/man7/mount_namespaces.7.html);
- [пространство имён межпроцессного взаимодействия](https://man7.org/linux/man-pages/man7/ipc_namespaces.7.html);
- [очереди процессов POSIX](https://man7.org/linux/man-pages/man7/mq_overview.7.html);
- [пространство имён UNIX Time-Sharing (UTS)](https://man7.org/linux/man-pages/man7/mq_overview.7.html).