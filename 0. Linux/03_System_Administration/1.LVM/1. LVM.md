### LVM: Logical Volume Management

> LVM — гибкая система управления дисками: позволяет объединять физические диски, динамически менять размер томов, делать снапшоты — без переразметки и перезагрузки.  
> Особенно полезно при:
> 
> - расширении `/`, `/home`, `/var` «на лету»,
> - подготовке к миграции или резервному копированию,
> - построении отказоустойчивых систем (с `mdadm` + LVM).

### 1. Основные понятия

|Уровень|Описание|Пример|
|---|---|---|
|**PV** — Physical Volume|Физическое устройство (диск/раздел), инициализированное для LVM|`/dev/sdb1`, `/dev/nvme0n1p3`|
|**VG** — Volume Group|Группа PV, объединённых в «пул» хранилища|`vg_main`, `data_vg`|
|**LV** — Logical Volume|Виртуальный «раздел» внутри VG — к нему можно обращаться как к `/dev/vg/lv`|`lv_root`, `lv_home`|
|**PE** — Physical Extent|Минимальная единица распределения (по умолчанию 4 MiB)|—|

> [!NOTE]  Метафора:  
>**PV = кирпичи**, **VG = склад кирпичей**, **LV = построенный дом** (можно перестраивать стены без закупки новых кирпичей).

### 2. Основные команды LVM
| Задача                        | Команда                                                                                        | Применение                                                                  |
| ----------------------------- | ---------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- |
| Активация VG (после загрузки) | `sudo vgchange -ay`                                                                            | Обычно делается автоматически, но нужно при ручной загрузке с live-носителя |
| Просмотр PV                   | `sudo pvs`<br>`sudo pvdisplay`                                                                 | Кратко / подробно                                                           |
| Просмотр VG                   | `sudo vgs`<br>`sudo vgdisplay`                                                                 | Включая свободное место (`Free PE / Size`)                                  |
| Просмотр LV                   | `sudo lvs`<br>`sudo lvdisplay`                                                                 | Покажет путь: `/dev/vg_name/lv_name` → можно монтировать как обычный раздел |
| Создать PV                    | `sudo pvcreate /dev/sdb1`                                                                      | ⚠️ **Уничтожит** существующую ФС!                                           |
| Создать VG                    | `sudo vgcreate vg_data /dev/sdb1 /dev/sdc1`                                                    | Объединяет несколько PV                                                     |
| Создать LV                    | `sudo lvcreate -L 20G -n lv_media vg_data`<br>`sudo lvcreate -l 100%FREE -n lv_backup vg_data` | `-L` — размер, `-l` — в PE/%                                                |
| Расширить LV                  | `sudo lvextend -L +10G /dev/vg_data/lv_media`                                                  | Только расширение (сжатие — сложнее и зависит от ФС)                        |
| Изменить размер ФС            | `sudo resize2fs /dev/vg_data/lv_media` (ext*)<br>`sudo xfs_growfs /mnt/media` (XFS)            | **Только после `lvextend`!** XFS можно растягивать **на mounted** томе.     |
| Удалить LV                    | `sudo lvremove /dev/vg_data/lv_old`                                                            | Сначала `umount`, потом `lvremove`                                          |
Проверка:
```bash
ls -l /dev/mapper/     # здесь живут LV-устройства: vg--name-lv--name (через двойной дефис)
ls -l /dev/vg_name/    # символьные ссылки на те же LV
```
### 3. Сценарий: расширить корень (`/`) за счёт нового диска

> [!NOTE] Условие:
> - Система уже на LVM, корень — `/dev/vg0/root`
> - Добавлен новый диск `/dev/sdb`, 50 GiB, свободен полностью.

#### Шаг 1. Создать PV и добавить в VG
```bash
sudo pvcreate /dev/sdb
sudo vgdisplay          # узнаём имя VG (например, `vg0`)
sudo vgextend vg0 /dev/sdb
# → Free PE увеличилось
```
#### Шаг 2. Расширить LV и ФС
```bash
# Расширить LV на максимум:
sudo lvextend -l +100%FREE /dev/vg0/root

# Расширить файловую систему (предположим, ext4):
sudo resize2fs /dev/vg0/root

# Или для XFS (даже на работающей системе!):
sudo xfs_growfs /
```
#### Шаг 3. Проверить
```bash
df -h /
vgs
lvs
```

Готово — `/` стал больше, без перезагрузки.


### 4. Снапшоты (snapshots)
	Позволяют «заморозить» состояние LV на момент создания — для бэкапа или экспериментов.

```bash
# Создать снапшот (резервируем 5 GiB под изменения):
sudo lvcreate -L 5G -s -n root_snap /dev/vg0/root

# Монтируем снапшот как read-only (осторожно!):
sudo mkdir /mnt/snap
sudo mount -o ro /dev/vg0/root_snap /mnt/snap

# После бэкапа — удаляем:
sudo umount /mnt/snap
sudo lvremove /dev/vg0/root_snap
```
	Снапшот — copy-on-write: если изменений > 5 GiB —снапшот «ломается».  
	Используй только для краткосрочных задач.

### 5. Диагностика и отладка LVM
| Задача                                   | Команда                                                                        | Примечание                                                        |
| ---------------------------------------- | ------------------------------------------------------------------------------ | ----------------------------------------------------------------- |
| Почему LVM не видит PV?                  | `sudo pvscan --cache`<br>`sudo vgscan`                                         | Обновить кэш метаданных                                           |
| Где хранятся метаданные?                 | `sudo dd if=/dev/sdb bs=1M count=1 \| strings \| grep LVM2`                    | В начале и конце PV (по умолчанию два блока по 1 MiB)             |
| Восстановить VG из бэкапа                | `sudo vgcfgrestore -f /etc/lvm/archive/vg0_00001-xxx.vg vg0`                   | Бэкапы хранятся в `/etc/lvm/archive/` автоматически при изменении |
| Загрузка с LVM в `mkinitcpio`            | Убедиться, что в `/etc/mkinitcpio.conf`:                                       |                                                                   |
| `HOOKS=(... block lvm2 filesystems ...)` | Без `lvm2` — система не найдёт корневой LV!                                    |                                                                   |
| Отладка через `strace`                   | `sudo strace -e openat,stat mount /dev/vg0/root /mnt/test 2>&1 \| grep -i lvm` | Полезно при «device not found»                                    |
Флаг **`--reportformat json`** у `pvs`/`vgs`/`lvs` — идеален для скриптов:
```bash
sudo vgs --reportformat json | jq '.report[0].vg[] | select(.vg_free_size > "10g")'
```

### 6. Ограничения и предостережения
- **Сжатие LV** (`lvreduce`) требует **предварительного уменьшения ФС** — и это **опасно**.  
    Для ext: `resize2fs /dev/vg/lv 10G` → `lvreduce -L 10G /dev/vg/lv`.  
    Для XFS — **сжатие невозможно** (только через `xfsdump` → новый LV).
- LVM + TRIM (для SSD): добавь `issue_discards = 1` в `/etc/lvm/lvm.conf`.
- Шифрование: LVM **поверх** LUKS (рекомендуется), а не наоборот:  
    `disk → LUKS → PV → VG → LV → ФС`.